<div class="dashboard">
  <header class="header">
    <h1>KPI ダッシュボード</h1>
    <p class="subtitle">AI活用状況・人材育成進捗レポート</p>
    <button class="data-manage-btn" (click)="openDataModal()">データ管理</button>
  </header>

  <div class="dashboard-grid">
    <!-- Section 1: GAI利用状況 -->
    <section class="card">
      <div class="card-header">
        <h2>GAI利用状況</h2>
      </div>
      <div class="card-content">
        <div class="chart-container">
          <h3>コアユーザ数の月別推移（3部署）</h3>
          <ngx-charts-line-chart
            [results]="coreUserData"
            [scheme]="colorScheme"
            [xAxis]="true"
            [yAxis]="true"
            [legend]="true"
            [showXAxisLabel]="true"
            [showYAxisLabel]="true"
            xAxisLabel="月"
            yAxisLabel="ユーザ数"
            [autoScale]="true"
            [view]="[500, 280]">
          </ngx-charts-line-chart>
        </div>
        <div class="chart-container">
          <h3>利用用途ごとの回数</h3>
          <ngx-charts-bar-horizontal
            [results]="usagePurposeData"
            [scheme]="colorScheme"
            [xAxis]="true"
            [yAxis]="true"
            [showXAxisLabel]="true"
            [showYAxisLabel]="true"
            xAxisLabel="回数"
            yAxisLabel="用途"
            [view]="[500, 280]">
          </ngx-charts-bar-horizontal>
        </div>
      </div>
    </section>

    <!-- Section 2: AI支援状況 -->
    <section class="card">
      <div class="card-header">
        <h2>AI支援状況</h2>
      </div>
      <div class="card-content">
        <div class="sub-section">
          <h3>案件数比較（受託 vs 全量）</h3>
          <div class="ai-support-cards">
            <div class="ai-support-card">
              <div class="ai-support-card-header">PoC</div>
              <div class="ai-support-card-body">
                <div class="progress-bar-container">
                  <div class="progress-bar-label">
                    <span>受託案件</span>
                    <span class="progress-value">{{editData.aiSupport.poc.contracted}}件</span>
                  </div>
                  <div class="progress-bar-track">
                    <div class="progress-bar-fill" [style.width.%]="getPocContractedRatio()"></div>
                  </div>
                </div>
                <div class="progress-bar-container">
                  <div class="progress-bar-label">
                    <span>全量案件</span>
                    <span class="progress-value">{{editData.aiSupport.poc.total}}件</span>
                  </div>
                  <div class="progress-bar-track full">
                    <div class="progress-bar-fill-light" style="width: 100%"></div>
                  </div>
                </div>
                <div class="ratio-display">
                  <span class="ratio-label">受託率</span>
                  <span class="ratio-value">{{getPocContractedRatio()}}%</span>
                </div>
              </div>
            </div>
            <div class="ai-support-card">
              <div class="ai-support-card-header">本番</div>
              <div class="ai-support-card-body">
                <div class="progress-bar-container">
                  <div class="progress-bar-label">
                    <span>受託案件</span>
                    <span class="progress-value">{{editData.aiSupport.production.contracted}}件</span>
                  </div>
                  <div class="progress-bar-track">
                    <div class="progress-bar-fill" [style.width.%]="getProductionContractedRatio()"></div>
                  </div>
                </div>
                <div class="progress-bar-container">
                  <div class="progress-bar-label">
                    <span>全量案件</span>
                    <span class="progress-value">{{editData.aiSupport.production.total}}件</span>
                  </div>
                  <div class="progress-bar-track full">
                    <div class="progress-bar-fill-light" style="width: 100%"></div>
                  </div>
                </div>
                <div class="ratio-display">
                  <span class="ratio-label">受託率</span>
                  <span class="ratio-value">{{getProductionContractedRatio()}}%</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="sub-section">
          <h3>発注金額比較</h3>
          <div class="amount-comparison">
            <div class="amount-table">
              <div class="amount-row header">
                <div class="amount-cell"></div>
                <div class="amount-cell">受託金額</div>
                <div class="amount-cell">全量金額</div>
                <div class="amount-cell">受託率</div>
              </div>
              <div class="amount-row">
                <div class="amount-cell label">PoC</div>
                <div class="amount-cell value">{{formatYen(editData.aiSupport.amount.poc.contracted)}}</div>
                <div class="amount-cell value">{{formatYen(editData.aiSupport.amount.poc.total)}}</div>
                <div class="amount-cell ratio">{{getPocAmountRatio()}}%</div>
              </div>
              <div class="amount-row">
                <div class="amount-cell label">本番</div>
                <div class="amount-cell value">{{formatYen(editData.aiSupport.amount.production.contracted)}}</div>
                <div class="amount-cell value">{{formatYen(editData.aiSupport.amount.production.total)}}</div>
                <div class="amount-cell ratio">{{getProductionAmountRatio()}}%</div>
              </div>
              <div class="amount-row total">
                <div class="amount-cell label">合計</div>
                <div class="amount-cell value">{{formatYen(getTotalContractedAmount())}}</div>
                <div class="amount-cell value">{{formatYen(getTotalAmount())}}</div>
                <div class="amount-cell ratio">{{getTotalAmountRatio()}}%</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Section 3: 学習・検証環境の利用状況 -->
    <section class="card">
      <div class="card-header">
        <h2>学習・検証環境の利用状況</h2>
      </div>
      <div class="card-content">
        <div class="metrics-row">
          <div class="metric-card">
            <div class="metric-value">{{editData.learningEnv.departments}}</div>
            <div class="metric-label">利用部署数</div>
          </div>
          <div class="metric-card">
            <div class="metric-value">{{editData.learningEnv.users}}</div>
            <div class="metric-label">登録者数</div>
          </div>
          <div class="metric-card">
            <div class="metric-value">{{formatYen(editData.learningEnv.totalCost)}}</div>
            <div class="metric-label">累計利用金額</div>
          </div>
        </div>
        <div class="chart-container">
          <h3>月別利用金額推移</h3>
          <ngx-charts-area-chart
            [results]="[{name: '利用金額', series: learningEnvCostData}]"
            [scheme]="colorScheme"
            [xAxis]="true"
            [yAxis]="true"
            [showXAxisLabel]="true"
            [showYAxisLabel]="true"
            xAxisLabel="月"
            yAxisLabel="金額"
            [yAxisTickFormatting]="yAxisTickFormatting"
            [autoScale]="true"
            [view]="[500, 250]">
          </ngx-charts-area-chart>
        </div>
      </div>
    </section>

    <!-- Section 4: 人材育成進捗状況 -->
    <section class="card">
      <div class="card-header">
        <h2>人材育成進捗状況</h2>
      </div>
      <div class="card-content">
        <div class="hr-progress-grid">
          <div class="hr-progress-card">
            <div class="hr-progress-header">
              <h3>見習い認定</h3>
              <div class="hr-progress-percentage">{{apprenticeData.percentage}}%</div>
            </div>
            <div class="hr-progress-bar-wrapper">
              <div class="hr-progress-bar-track">
                <div class="hr-progress-bar-fill" [style.width.%]="apprenticeData.percentage"></div>
              </div>
            </div>
            <div class="hr-progress-details">
              <div class="hr-progress-detail">
                <span class="detail-number">{{apprenticeData.certified}}</span>
                <span class="detail-label">認定者数</span>
              </div>
              <div class="hr-progress-divider">/</div>
              <div class="hr-progress-detail">
                <span class="detail-number">{{apprenticeData.total}}</span>
                <span class="detail-label">対象者数</span>
              </div>
            </div>
          </div>
          <div class="hr-progress-card">
            <div class="hr-progress-header">
              <h3>独り立ち認定</h3>
              <div class="hr-progress-percentage">{{independentData.percentage}}%</div>
            </div>
            <div class="hr-progress-bar-wrapper">
              <div class="hr-progress-bar-track">
                <div class="hr-progress-bar-fill" [style.width.%]="independentData.percentage"></div>
              </div>
            </div>
            <div class="hr-progress-details">
              <div class="hr-progress-detail">
                <span class="detail-number">{{independentData.certified}}</span>
                <span class="detail-label">認定者数</span>
              </div>
              <div class="hr-progress-divider">/</div>
              <div class="hr-progress-detail">
                <span class="detail-number">{{independentData.total}}</span>
                <span class="detail-label">対象者数</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <footer class="footer">
    <p>最終更新: 2025年12月</p>
  </footer>
</div>

<!-- Data Management Modal -->
<div class="modal-overlay" *ngIf="showDataModal" (click)="closeDataModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>データ管理</h2>
      <button class="modal-close" (click)="closeDataModal()">&times;</button>
    </div>
    
    <div class="modal-tabs">
      <button [class.active]="activeTab === 'gai'" (click)="activeTab = 'gai'">GAI利用状況</button>
      <button [class.active]="activeTab === 'ai'" (click)="activeTab = 'ai'">AI支援状況</button>
      <button [class.active]="activeTab === 'learning'" (click)="activeTab = 'learning'">学習・検証環境</button>
      <button [class.active]="activeTab === 'hr'" (click)="activeTab = 'hr'">人材育成</button>
    </div>
    
    <div class="modal-body">
      <!-- GAI利用状況 Tab -->
      <div *ngIf="activeTab === 'gai'" class="tab-content">
        <h3>利用用途ごとの回数</h3>
        <div class="form-grid">
          <div class="form-row" *ngFor="let item of editData.gaiUsage.usagePurpose; let i = index">
            <label>{{item.name}}</label>
            <input type="number" [(ngModel)]="editData.gaiUsage.usagePurpose[i].value" />
          </div>
        </div>
      </div>
      
      <!-- AI支援状況 Tab -->
      <div *ngIf="activeTab === 'ai'" class="tab-content">
        <h3>案件数</h3>
        <div class="form-section">
          <h4>PoC</h4>
          <div class="form-row">
            <label>受託案件数</label>
            <input type="number" [(ngModel)]="editData.aiSupport.poc.contracted" />
          </div>
          <div class="form-row">
            <label>全量案件数</label>
            <input type="number" [(ngModel)]="editData.aiSupport.poc.total" />
          </div>
        </div>
        <div class="form-section">
          <h4>本番</h4>
          <div class="form-row">
            <label>受託案件数</label>
            <input type="number" [(ngModel)]="editData.aiSupport.production.contracted" />
          </div>
          <div class="form-row">
            <label>全量案件数</label>
            <input type="number" [(ngModel)]="editData.aiSupport.production.total" />
          </div>
        </div>
        <h3>発注金額（円）</h3>
        <div class="form-section">
          <h4>PoC</h4>
          <div class="form-row">
            <label>受託金額</label>
            <input type="number" [(ngModel)]="editData.aiSupport.amount.poc.contracted" />
          </div>
          <div class="form-row">
            <label>全量金額</label>
            <input type="number" [(ngModel)]="editData.aiSupport.amount.poc.total" />
          </div>
        </div>
        <div class="form-section">
          <h4>本番</h4>
          <div class="form-row">
            <label>受託金額</label>
            <input type="number" [(ngModel)]="editData.aiSupport.amount.production.contracted" />
          </div>
          <div class="form-row">
            <label>全量金額</label>
            <input type="number" [(ngModel)]="editData.aiSupport.amount.production.total" />
          </div>
        </div>
      </div>
      
      <!-- 学習・検証環境 Tab -->
      <div *ngIf="activeTab === 'learning'" class="tab-content">
        <h3>基本情報</h3>
        <div class="form-row">
          <label>利用部署数</label>
          <input type="number" [(ngModel)]="editData.learningEnv.departments" />
        </div>
        <div class="form-row">
          <label>登録者数</label>
          <input type="number" [(ngModel)]="editData.learningEnv.users" />
        </div>
        <div class="form-row">
          <label>累計利用金額（円）</label>
          <input type="number" [(ngModel)]="editData.learningEnv.totalCost" />
        </div>
      </div>
      
      <!-- 人材育成 Tab -->
      <div *ngIf="activeTab === 'hr'" class="tab-content">
        <h3>見習い認定</h3>
        <div class="form-row">
          <label>認定者数</label>
          <input type="number" [(ngModel)]="editData.hrDevelopment.apprentice.certified" />
        </div>
        <div class="form-row">
          <label>対象者数</label>
          <input type="number" [(ngModel)]="editData.hrDevelopment.apprentice.total" />
        </div>
        <h3>独り立ち認定</h3>
        <div class="form-row">
          <label>認定者数</label>
          <input type="number" [(ngModel)]="editData.hrDevelopment.independent.certified" />
        </div>
        <div class="form-row">
          <label>対象者数</label>
          <input type="number" [(ngModel)]="editData.hrDevelopment.independent.total" />
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <div class="modal-actions-left">
        <button class="btn-secondary" (click)="exportData()">エクスポート</button>
        <label class="btn-secondary file-input-label">
          インポート
          <input type="file" accept=".json" (change)="importData($event)" hidden />
        </label>
        <button class="btn-danger" (click)="resetData()">リセット</button>
      </div>
      <div class="modal-actions-right">
        <button class="btn-secondary" (click)="closeDataModal()">キャンセル</button>
        <button class="btn-primary" (click)="saveData()">保存</button>
      </div>
    </div>
  </div>
</div>
